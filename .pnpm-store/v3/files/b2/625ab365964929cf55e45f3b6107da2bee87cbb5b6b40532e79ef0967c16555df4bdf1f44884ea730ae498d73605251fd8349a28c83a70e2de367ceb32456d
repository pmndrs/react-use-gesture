"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),r=require("@babel/runtime/helpers/objectWithoutPropertiesLoose"),t=require("three"),n=require("react"),u=require("@react-three/fiber"),a=require("react-merge-refs"),c=require("../helpers/Position.cjs.js");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}require("@babel/runtime/helpers/inheritsLoose");var l,s=i(e),f=i(r),d=o(t),m=o(n),b=i(a),h=m.createContext(null),p=new d.Matrix4,v=new d.Color;var y=m.forwardRef((function(e,r){var t=e.children,n=f.default(e,["children"]);m.useMemo((function(){return u.extend({Position:c.Position})}),[]);var a=m.useRef(),i=m.useContext(h).subscribe;return m.useLayoutEffect((function(){return i(a)}),[]),m.createElement("position",s.default({matrixAutoUpdate:!1,ref:b.default([r,a])},n),t)}));exports.Instance=y,exports.Instances=function(e){var r=e.children,t=e.range,n=e.limit,a=void 0===n?1e3:n,c=f.default(e,["children","range","limit"]),i=m.useRef(null),o=m.useState([]),d=o[0],b=o[1],y=m.useState((function(){var e=[].concat(new Array(16*a)).map((function(){return 0})),r=[].concat(new Array(3*a)).map((function(){return 1}));return[new Float32Array(e),new Float32Array(r)]}))[0],x=y[0],g=y[1];m.useLayoutEffect((function(){i.current.count=i.current.instanceMatrix.updateRange.count=i.current.instanceColor.updateRange.count=Math.min(a,void 0!==t?t:a,d.length)}),[d,t]),u.useFrame((function(){for(l=0;l<d.length;l++)d[l].current.updateMatrix(),d[l].current.matrixWorldNeedsUpdate=!1,d[l].current.matrixWorld.equals(p.fromArray(x,16*l))||(d[l].current.matrixWorld.toArray(x,16*l),i.current.instanceMatrix.needsUpdate=!0),d[l].current.color.equals(v.fromArray(g,3*l))||(d[l].current.color.toArray(g,3*l),i.current.instanceColor.needsUpdate=!0)}));var j=m.useMemo((function(){var e={};for(l=0;l<d.length;l++){var r;Object.assign(e,null==(r=d[l].current)?void 0:r.__r3f.handlers)}return Object.keys(e).reduce((function(e,r){var t;return s.default({},e,((t={})[r]=function(e){var t,n,u;return null==(t=d[e.instanceId].current)||null==(n=t.__r3f)||null==(u=n.handlers)?void 0:u[r](e)},t))}),{})}),[d]),M=m.useMemo((function(){return{subscribe:function(e){return b((function(r){return[].concat(r,[e])})),function(){return b((function(r){return r.filter((function(r){return r.current!==e.current}))}))}}}}),[]);return m.createElement("instancedMesh",s.default({ref:i,args:[null,null,0]},j,c),m.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:x.length/16,array:x,itemSize:16}),m.createElement("instancedBufferAttribute",{attach:"instanceColor",count:g.length/3,array:g,itemSize:3}),m.createElement(h.Provider,{value:M},r))};
